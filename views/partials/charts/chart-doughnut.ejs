<script type="text/javascript">
    const sortDataAndLabels = (keys, values) => {
        const zip = (a, b) => a.map((k, i) => [k, b[i]]);
        const rsort = (a, b) => parseFloat(b[1]) - parseFloat(a[1]);
        const result = zip(keys, values).sort(rsort);
        var sk=[], sv=[];
        result.forEach(i => {
            sk.push(i[0]);
            sv.push(i[1]);
        });
        return [sk, sv];
    };

    var canvases = document.querySelectorAll('[data-chart-doughnut]');
    canvases.forEach(canvas => {
        const lines = canvas.getAttribute('data-chart-doughnut').split(',');
        const data = canvas.getAttribute('data-chart-doughnut-data').split(',');
        const labels = canvas.getAttribute('data-chart-doughnut-labels').split(',');
        const [slabels, sdata] = sortDataAndLabels(labels, data);
        const backgroundColor = Array(data.length).fill('rgba(54, 162, 235, 0.4)');
        const borderColor = Array(data.length).fill('rgba(54, 162, 235, 1)');
        var ctx = canvas.getContext('2d');
        var chart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: slabels,
                datasets: [{
                    data: sdata,
                    backgroundColor,
                    borderWidth: 1,
                }],
            },
            options: {
                aspectRatio: 1,
                cutoutPercentage: 85,
                title: { display: false },
                legend: { display: false },
                centerText: {
                    display: true,
                    lines,
                },
                tooltips: { enabled: true },
            },
        })
    });

    Chart.pluginService.register({
        beforeDraw: function (chart) {
            const lines = chart.options.centerText.lines;
            if (!chart.options.centerText.display || !lines.length) {
                return;
            }

            const height = chart.chart.height;
            const fontSize = (height / 200).toFixed(2);
            
            var ctx = chart.chart.ctx;
            ctx.font = fontSize + "em arial";
            ctx.textAlign = 'center';
            ctx.textBaseline = "middle";
            
            const lineHeight = 25;
            const centerX = ((chart.chartArea.left + chart.chartArea.right) / 2);
            var centerY = ((chart.chartArea.top + chart.chartArea.bottom) / 2);
            centerY -= (lines.length - 1) * lineHeight / 2;
            lines.forEach(line => {
                ctx.fillText(line, centerX, centerY);
                centerY += lineHeight;
            });
        }
    });
</script>